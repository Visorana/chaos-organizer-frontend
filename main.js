!function(){"use strict";class e{constructor(e){this.server=e,this.wsServer=this.server.replace(/^http/i,"ws"),this.data={event:"load"},this.callbacks={error:()=>{throw Error("Connection error")}},this.onOpen=this.onOpen.bind(this),this.onMessage=this.onMessage.bind(this)}init(){this.ws=new WebSocket(this.wsServer),this.callbacks.pending(),this.ws.addEventListener("open",this.onOpen),this.ws.addEventListener("message",this.onMessage),this.ws.addEventListener("error",this.callbacks.error),this.ws.addEventListener("close",this.callbacks.error)}onOpen(){this.callbacks.success(),this.ws.send(JSON.stringify(this.data))}onMessage(e){const s=JSON.parse(e.data);"database"===s.event&&(this.callbacks.load(s.dB,s.favourites,s.position),s.pinnedMessage&&this.callbacks.pinMessage(s.pinnedMessage.type,s.pinnedMessage.id,s.pinnedMessage.message,s.pinnedMessage.geo,s.pinnedMessage.date),this.callbacks.sideLoad(s.side)),"text"===s.event&&(this.callbacks.message(s.id,s.message,s.geo,s.date),this.callbacks.sideLoad(s.side)),"file"===s.event&&(this.callbacks.file(s.type,s.id,s.message,s.geo,s.date),this.callbacks.sideLoad(s.side)),"storage"===s.event&&this.callbacks.sideCategory(s),"select"===s.event&&this.callbacks.showMessage(s.message),"delete"===s.event&&(this.callbacks.delete(s.id),this.callbacks.sideLoad(s.side)),"favourite"===s.event&&(this.callbacks.favourite(s.id),this.callbacks.sideLoad(s.side)),"favouriteRemove"===s.event&&(this.callbacks.favouriteRemove(s.id),this.callbacks.sideLoad(s.side)),"favouritesLoad"===s.event&&(this.callbacks.load(s.dB,s.favourites,0),s.pinnedMessage&&this.callbacks.pinMessage(s.pinnedMessage.type,s.pinnedMessage.id,s.pinnedMessage.message,s.pinnedMessage.geo,s.pinnedMessage.date),this.callbacks.sideFavourites(s.dB)),"pin"===s.event&&(this.callbacks.pin(s.pinnedMessage.id),this.callbacks.pinMessage(s.pinnedMessage.type,s.pinnedMessage.id,s.pinnedMessage.message,s.pinnedMessage.geo,s.pinnedMessage.date)),"unpin"===s.event&&this.callbacks.unpin(s.id)}send(e,s){1===this.ws.readyState?(this.data={event:e,message:s},this.ws.send(JSON.stringify(this.data))):this.callbacks.error()}sendFile(e){const s=new XMLHttpRequest;s.open("POST",`${this.server}/upload`),s.addEventListener("error",(()=>this.callbacks.error())),s.send(e)}}class s{static createMessageContainer(e,s,t){const i=new Intl.DateTimeFormat("ru",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}),a=document.createElement("div");return a.classList.add("chaos_messages_message"),a.innerHTML=`\n      <div class="chaos_message_header">\n        <div class="chaos_message_tools"></div>\n      </div>\n      <div class="chaos_message_body">\n        ${e}\n      </div>`,s&&(a.innerHTML+=`\n        <div class="chaos_message_geo">\n          <div class="chaos_geo_icon"></div>\n          <a href="https://yandex.ru/maps/?text=${s}" target="_blank">[${s}]</a>\n        </div>`),a.innerHTML+=`\n      <div class="chaos_message_date">\n        ${i.format(t)}\n      </div>`,a}static createMessageElement(e,t,i){const a=`<p>${this.linkify(e)}</p>`;return s.createMessageContainer(a,t,i)}static createImageElement(e,t,i,a){const o=`<img class="chaos_messages_image" src="${e}/${t}">`;return s.createMessageContainer(o,i,a)}static createVideoElement(e,t,i,a){const o=`<video class="chaos_messages_video" src="${e}/${t}" controls></video>`;return s.createMessageContainer(o,i,a)}static createAudioElement(e,t,i,a){const o=`<audio class="chaos_messages_audio" src="${e}/${t}" controls></audio>`;return s.createMessageContainer(o,i,a)}static createFileElement(e,t,i,a){const o=`\n      <div class="chaos_messages_file">\n        <a href="${e}/${t}">\n          <div class="chaos_messages_file_bg"></div>\n        </a>\n        <a href="${e}/${t}">${t}</a>\n      </div>`;return s.createMessageContainer(o,i,a)}static createToolsElements(){const e=document.createElement("div");return e.classList.add("chaos_message_tools_container"),e.innerHTML='\n        <div class="chaos_message_tools_delete"></div>\n        <div class="chaos_message_tools_pin"></div>\n        <div class="chaos_message_tools_favourite"></div>\n      ',e}static getFavouriteMark(){const e=document.createElement("div");return e.classList.add("chaos_message_favourite"),e}static getPinMark(){const e=document.createElement("div");return e.classList.add("chaos_message_pin"),e}static getPinnedMessage(e){const s=document.createElement("div");return s.classList.add("chaos_pinned"),s.innerHTML=`\n        <div class="chaos_pinned_container">\n          ${e.innerHTML}\n        </div>\n        <div class="chaos_pinned_side">\n          <div class="chaos_pinned_title">Pinned message<div class="chaos_pinned_close"></div></div>\n          <div class="chaos_pinned_select"></div>\n        </div>\n      `,s}static createSelectContainer(e){const s=document.createElement("div");s.classList.add("chaos_messages","chaos_select_container");const t=new Intl.DateTimeFormat("ru",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});return s.innerHTML=`\n    <div class="chaos_select_header">\n      Message from ${t.format(e)}\n      <div class="chaos_select_close"></div>\n    </div>`,s}static createPendingConnectionElement(){const e=document.createElement("div");return e.classList.add("chaos_connection_pending"),e}static createErrorConnectionElement(){const e=document.createElement("div");return e.classList.add("chaos_connection_error"),e}static createSideElement(e,s,t){const i=document.createElement("li");return i.classList.add("chaos_side_item",e),i.innerHTML=`${s}: <span>${t}</span>`,i}static createSideSubheadElement(e){const s=document.createElement("div");return s.classList.add("chaos_side_subhead"),s.innerHTML=`<h3>${e}</h3><div class="chaos_side_close"></div>`,s}static createSideCategoryList(){const e=document.createElement("ul");return e.classList.add("chaos_side_list"),e}static createSideElementContainer(e){const s=document.createElement("li");return s.classList.add("chaos_side_item","chaos_side_open_item"),s.innerHTML=`\n      <div class="chaos_side_open_container">\n        <div class="chaos_side_open_select"></div>\n        <div class="chaos_side_open_element">\n          ${e}\n        </div>\n      </div>\n    `,s}static createSideLinkElement(e){const t=`<p><a href="${e}">${e}</a></p>`;return s.createSideElementContainer(t)}static createSideImageElement(e,t){const i=`<img class="chaos_messages_image" src="${t}/${e}">`;return s.createSideElementContainer(i)}static createSideVideoElement(e,t){const i=`<video class="chaos_messages_video" src="${t}/${e}" controls></video>`;return s.createSideElementContainer(i)}static createSideAudioElement(e,t){const i=`<audio class="chaos_messages_audio" src="${t}/${e}" controls></audio>`;return s.createSideElementContainer(i)}static createSideFileElement(e,t){const i=`<p><a href="${t}/${e}">${e}</a></p>`;return s.createSideElementContainer(i)}static createFavouritesDescription(e){const s=document.createElement("li");return s.classList.add("chaos_side_item","chaos_side_open_item"),s.innerHTML=`\n      <div class="chaos_side_open_container">\n        <div class="chaos_side_open_element">\n          <p class="chaos_side_favourites_description">Total messages: <b>${e}</b><br>\n        </div>\n      </div>\n    `,s}static getAddForm(){const e=document.createElement("label");return e.classList.add("chaos_file_label"),e.innerHTML='\n      <div class="chaos_file_input">Choose file</div>\n      <input type="file" class="chaos_file_hidden">',e}static getMediaForm(e){const s=document.createElement("div");return s.classList.add("chaos_media_container"),s.innerHTML=`\n      <div class="chaos_media_record"></div>\n      <div class="chaos_media_status">\n        Ожидание ${e}\n      </div>\n      <div class="chaos_media_stop"></div>`,s}static createGeoElement(e){const s=document.createElement("div");return s.classList.add("chaos_geo"),s.innerHTML=`\n      <div class="chaos_geo_icon"></div>\n      [${e}]\n      <div class="chaos_geo_close"></div>\n      `,s}static errorMediaForm(){const e=document.createElement("div");return e.classList.add("chaos_media_container"),e.innerHTML='\n      <div class="chaos_media_status">\n        Ваш браузер не поддерживает запись медиа\n      </div>',e}static getCloseForm(){const e=document.createElement("div");return e.classList.add("chaos_form_close"),e}static createDropPlace(){const e=document.createElement("div");return e.classList.add("chaos_dropplace_container"),e.innerHTML='<div class="chaos_dropplace"></div>',e}static linkify(e){return e.replace(/((http:\/\/|https:\/\/){1}(www)?([\da-z.-]+)\.([a-z.]{2,6})([/\w.-?%#&-]*)*\/?)/gi,'<a href="$1">$1</a>')}}class t{constructor(e,t,i){this.parentElement=e,this.listElement=this.parentElement.querySelector(".chaos_side_list"),this.messageClass=t,this.request=i,this.render=this.render.bind(this),this.closeCategory=this.closeCategory.bind(this),this.showCategoryItems=this.showCategoryItems.bind(this),this.showFavouritesDescription=this.showFavouritesDescription.bind(this),this.categoryItems={links:{class:"chaos_side_links",text:"Links",handler:s.createSideLinkElement},favourites:{class:"chaos_side_favourites",text:"Favorites",handler:s.createSideFavouriteElement},image:{class:"chaos_side_images",text:"Images",handler:s.createSideImageElement},file:{class:"chaos_side_files",text:"Files",handler:s.createSideFileElement},video:{class:"chaos_side_videos",text:"Video",handler:s.createSideVideoElement},audio:{class:"chaos_side_audios",text:"Audio",handler:s.createSideAudioElement}}}render(e){this.listElement.innerHTML="";for(const t in e){const i=s.createSideElement(this.categoryItems[t].class,this.categoryItems[t].text,e[t]);this.listElement.append(i),e[t]>0&&i.addEventListener("click",(()=>this.requestCategoryItems(t)))}}requestCategoryItems(e){if("favourites"===e){for(this.category="favourites",this.openCategory(this.categoryItems[e].text);this.messageClass.messagesElement.firstChild;)this.messageClass.messagesElement.removeChild(this.messageClass.messagesElement.firstChild);return this.messageClass.messages.clear(),void this.request.send("favouritesLoad")}this.openCategory(this.categoryItems[e].text),this.request.send("storage",e)}openCategory(e){const t=s.createSideSubheadElement(e),i=t.querySelector(".chaos_side_close");this.listElement.replaceWith(t),i.addEventListener("click",this.closeCategory)}closeCategory(){if(this.parentElement.querySelector(".chaos_side_subhead").remove(),this.parentElement.querySelector(".chaos_side_list").remove(),"favourites"===this.category){for(;this.messageClass.messagesElement.firstChild;)this.messageClass.messagesElement.removeChild(this.messageClass.messagesElement.firstChild);return this.messageClass.messages.clear(),this.request.send("load"),this.parentElement.append(this.listElement),void(this.category="")}this.parentElement.append(this.listElement),this.messageClass.closeSelectMessage()}showCategoryItems(e){const t=s.createSideCategoryList();for(const s of e.data){const i=this.categoryItems[e.category].handler(s.name,this.request.server);t.append(i),i.querySelector(".chaos_side_open_select").addEventListener("click",(()=>this.request.send("select",s.messageId)))}this.parentElement.append(t)}showFavouritesDescription(e){const t=s.createSideCategoryList(),i=s.createFavouritesDescription(e.length);t.append(i),this.parentElement.append(t)}}class i{constructor(e,s,t){this.parentElement=e,this.formElement=this.parentElement.querySelector(".chaos_form"),this.mainElement=this.parentElement.querySelector(".chaos_main"),this.clipElement=this.formElement.querySelector(".chaos_form_clip"),this.inputElement=this.formElement.querySelector(".chaos_form_input"),this.buttonElement=this.formElement.querySelector(".chaos_file_button"),this.dropplace=this.parentElement.querySelector(".chaos_dropplace"),this.geolocation=s,this.request=t,this.openForm=this.openForm.bind(this),this.closeForm=this.closeForm.bind(this),this.showDropPlace=this.showDropPlace.bind(this),this.hideDropPlace=this.hideDropPlace.bind(this),this.loadFile=this.loadFile.bind(this)}openForm(){for(;this.formElement.firstChild;)this.formElement.removeChild(this.formElement.firstChild);this.closeElement=s.getCloseForm(),this.addFormElement=s.getAddForm(),this.formElement.append(this.closeElement,this.addFormElement,this.clipElement),this.geolocation.coords&&this.formElement.append(this.geolocation.geoElement),this.inputFileElement=this.addFormElement.querySelector("input.chaos_file_hidden"),this.dropplace=s.createDropPlace(),this.mainElement.prepend(this.dropplace),this.closeElement.addEventListener("click",this.closeForm),this.mainElement.addEventListener("dragover",this.showDropPlace),this.dropplace.addEventListener("dragleave",this.hideDropPlace),this.dropplace.addEventListener("drop",this.loadFile),this.inputFileElement.addEventListener("change",this.loadFile)}closeForm(){this.closeElement.remove(),this.clipElement.classList.remove("chaos_form_clip_active"),this.addFormElement.replaceWith(this.inputElement)}showDropPlace(e){e.preventDefault(),this.dropplace.style.visibility="visible"}hideDropPlace(){this.dropplace.style.visibility="hidden"}loadFile(e){e.preventDefault();const s=this.inputFileElement.files[0]||e.dataTransfer.files[0],t=new FormData;t.append("file",s),t.append("geo",this.geolocation.coords),this.request.sendFile(t),this.hideDropPlace(),this.mainElement.removeEventListener("dragover",this.showDropPlace),this.closeForm(),this.geolocation.removeCoords()}}class a{constructor(e,s,t){this.formElement=e,this.inputElement=this.formElement.querySelector(".chaos_form_input"),this.clipElement=this.formElement.querySelector(".chaos_form_clip"),this.geolocation=s,this.request=t,this.openMedia=this.openMedia.bind(this),this.closeForm=this.closeForm.bind(this),this.startRecording=this.startRecording.bind(this),this.stopRecording=this.stopRecording.bind(this)}openMedia(e){const s={audio:!0};let t="аудио";if(e.target.classList.contains("chaos_add_video")?(s.video=!0,this.blobType="video/mp4",t="видео"):this.blobType="audio/wav",navigator.mediaDevices&&window.MediaRecorder){try{navigator.mediaDevices.getUserMedia(s).then((e=>{this.stream=e,this.recorder=new MediaRecorder(this.stream)})).catch((()=>this.showError()))}catch(e){this.showError()}this.openMediaForm(t)}else this.showError()}openMediaForm(e){for(;this.formElement.firstChild;)this.formElement.removeChild(this.formElement.firstChild);this.closeElement=s.getCloseForm(),this.addMediaElement=s.getMediaForm(e),this.formElement.append(this.closeElement,this.addMediaElement,this.clipElement),this.geolocation.coords&&this.formElement.append(this.geolocation.geoElement),this.recordStart=this.addMediaElement.querySelector(".chaos_media_record"),this.recordStop=this.addMediaElement.querySelector(".chaos_media_stop"),this.statusRecord=this.addMediaElement.querySelector(".chaos_media_status"),this.recordStart.addEventListener("click",this.startRecording),this.recordStop.addEventListener("click",this.stopRecording),this.closeElement.addEventListener("click",this.closeForm)}closeForm(){this.closeElement.remove(),this.clipElement.classList.remove("chaos_form_clip_active"),this.addMediaElement.replaceWith(this.inputElement)}showError(){for(;this.formElement.firstChild;)this.formElement.removeChild(this.formElement.firstChild);this.closeElement=s.getCloseForm(),this.addMediaElement=s.errorMediaForm(),this.formElement.append(this.closeElement,this.addMediaElement,this.clipElement),this.closeElement.addEventListener("click",this.closeForm)}startRecording(){this.chunks=[],this.recorder.addEventListener("dataavailable",(e=>{this.chunks.push(e.data)})),this.recorder.addEventListener("stop",(()=>{this.loadFile()})),this.recorder.start(),this.showStatus()}stopRecording(){"inactive"!==this.recorder.state&&(clearInterval(this.timerInterval),this.statusRecord.innerText="Recording is complete. Sending.",this.recorder.stop(),this.stream.getTracks().forEach((e=>e.stop())))}showStatus(){let e=0;this.statusRecord.innerText=`Recording: ${e} sec.`,this.timerInterval=setInterval((()=>{e+=1,this.statusRecord.innerText=`Recording: ${e} sec.`}),1e3)}loadFile(){const e=new Blob(this.chunks,{type:this.blobType}),s=new FormData;s.append("file",e),s.append("geo",this.geolocation.coords),this.request.sendFile(s),this.closeForm(),this.geolocation.removeCoords()}}class o{constructor(e){this.formElement=e,this.coords="",this.geoElement="",this.attachGeo=this.attachGeo.bind(this),this.removeCoords=this.removeCoords.bind(this)}attachGeo(){this.promiseThroughAPI().then((e=>{this.addCoords(e)})).catch((()=>{this.addCoords()}))}promiseThroughAPI(){return navigator.geolocation?new Promise(((e,s)=>{navigator.geolocation.getCurrentPosition((s=>{e({latitude:s.coords.latitude,longitude:s.coords.longitude})}),(e=>{s(e)}))})):new Promise(((e,s)=>s(new Error("No Geolocation API"))))}addCoords(e){let t="Coordinates not defined";if(this.geoElement&&this.removeCoords(),e){const{latitude:s,longitude:i}=e;t=`${s.toFixed(6)}, ${i.toFixed(6)}`,this.coords=t}this.geoElement=s.createGeoElement(t),this.formElement.append(this.geoElement),this.geoElement.querySelector(".chaos_geo_close").addEventListener("click",this.removeCoords)}removeCoords(){this.coords="",this.geoElement&&this.geoElement.remove()}}class n{constructor(e,s){this.messageClass=e,this.request=s,this.pinMessage=this.pinMessage.bind(this),this.unpinMessage=this.unpinMessage.bind(this),this.markPinnedMessage=this.markPinnedMessage.bind(this),this.unmarkPinnedMessage=this.unmarkPinnedMessage.bind(this),this.showPinnedMessage=this.showPinnedMessage.bind(this),this.removePinnedMessage=this.removePinnedMessage.bind(this)}pinMessage(e){const s=this.messageClass.messages.get(e.target.closest(".chaos_messages_message"));s!==this.pinnedMessage&&(this.request.send("pin",s),this.messageClass.closeMessageTools(e))}unpinMessage(){this.request.send("unpin",this.pinnedMessage)}markPinnedMessage(e){this.unmarkPinnedMessage();const t=[...this.messageClass.messages.entries()].filter((({1:s})=>s===e)).map((([e])=>e)),i=s.getPinMark();t[0].querySelector(".chaos_message_header").prepend(i),i.addEventListener("click",this.unpinMessage)}unmarkPinnedMessage(){const e=this.messageClass.messagesElement.querySelector(".chaos_message_pin");e&&e.remove(),this.removePinnedMessage()}showPinnedMessage(e,t,i,a,o){this.removePinnedMessage(),this.pinnedMessage=t;const n=this.messageClass.buildMessageElement(e,t,i,a,o);this.pinnedMessageElement=s.getPinnedMessage(n.querySelector(".chaos_message_body")),this.messageClass.messagesElement.append(this.pinnedMessageElement),this.pinnedMessageElement.querySelector(".chaos_pinned_close").addEventListener("click",this.unpinMessage),this.pinnedMessageElement.querySelector(".chaos_pinned_select").addEventListener("click",(()=>this.request.send("select",this.pinnedMessage)))}removePinnedMessage(){this.messageClass.messagesElement.querySelector(".chaos_pinned")&&(this.pinnedMessageElement.remove(),this.pinnedMessage="")}}class r{constructor(e,s){this.messageClass=e,this.request=s,this.addToFavourites=this.addToFavourites.bind(this),this.removeFromFavourites=this.removeFromFavourites.bind(this),this.showFavouriteMark=this.showFavouriteMark.bind(this),this.removeFavouriteMark=this.removeFavouriteMark.bind(this)}addToFavourites(e){const s=this.messageClass.messages.get(e.target.closest(".chaos_messages_message"));e.target.closest(".chaos_messages_message").querySelector(".chaos_message_favourite")||(this.request.send("favourite",s),this.messageClass.closeMessageTools(e))}removeFromFavourites(e){const s=this.messageClass.messages.get(e.target.closest(".chaos_messages_message"));this.request.send("favouriteRemove",s)}showFavouriteMark(e){const t=[...this.messageClass.messages.entries()].filter((({1:s})=>s===e)).map((([e])=>e)),i=s.getFavouriteMark();t[0].querySelector(".chaos_message_header").prepend(i),i.addEventListener("click",this.removeFromFavourites)}removeFavouriteMark(e){[...this.messageClass.messages.entries()].filter((({1:s})=>s===e)).map((([e])=>e))[0].querySelector(".chaos_message_favourite").remove()}}new class{constructor(s,c){this.server=c,this.parentElement=s,this.formElement=this.parentElement.querySelector(".chaos_form"),this.inputElement=this.formElement.querySelector(".chaos_form_input"),this.clipElement=this.formElement.querySelector(".chaos_form_clip"),this.addFormElement=this.formElement.querySelector(".chaos_add_container"),this.addFileElement=this.addFormElement.querySelector(".chaos_add_files"),this.addAudioElement=this.addFormElement.querySelector(".chaos_add_audio"),this.addVideoElement=this.addFormElement.querySelector(".chaos_add_video"),this.addGeoElement=this.addFormElement.querySelector(".chaos_add_geo"),this.messagesElement=this.parentElement.querySelector(".chaos_messages"),this.messages=new Map,this.request=new e(this.server),this.sidePanel=new t(this.parentElement.querySelector(".chaos_side"),this,this.request),this.geolocation=new o(this.formElement),this.fileLoader=new i(this.parentElement,this.geolocation,this.request),this.mediaLoader=new a(this.formElement,this.geolocation,this.request),this.pin=new n(this,this.request),this.favourites=new r(this,this.request),this.submitForm=this.submitForm.bind(this),this.showAddForm=this.showAddForm.bind(this),this.removeError=this.removeError.bind(this),this.connectionPending=this.connectionPending.bind(this),this.connectionSuccess=this.connectionSuccess.bind(this),this.connectionError=this.connectionError.bind(this),this.addMessage=this.addMessage.bind(this),this.addFile=this.addFile.bind(this),this.renderMessages=this.renderMessages.bind(this),this.lazyLoad=this.lazyLoad.bind(this),this.showSelectMessage=this.showSelectMessage.bind(this),this.closeSelectMessage=this.closeSelectMessage.bind(this),this.showMessageDot=this.showMessageDot.bind(this),this.removeMessageDot=this.removeMessageDot.bind(this),this.showMessageTools=this.showMessageTools.bind(this),this.closeMessageTools=this.closeMessageTools.bind(this),this.deleteMessage=this.deleteMessage.bind(this),this.deleteMessageElement=this.deleteMessageElement.bind(this)}init(){this.request.callbacks={pending:this.connectionPending,success:this.connectionSuccess,error:this.connectionError,load:this.renderMessages,message:this.addMessage,file:this.addFile,showMessage:this.showSelectMessage,delete:this.deleteMessageElement,favourite:this.favourites.showFavouriteMark,favouriteRemove:this.favourites.removeFavouriteMark,sideLoad:this.sidePanel.render,sideCategory:this.sidePanel.showCategoryItems,sideFavourites:this.sidePanel.showFavouritesDescription,pin:this.pin.markPinnedMessage,pinMessage:this.pin.showPinnedMessage,unpin:this.pin.unmarkPinnedMessage},this.request.init(),this.messagesElement.addEventListener("scroll",this.lazyLoad),this.formElement.addEventListener("submit",this.submitForm),this.clipElement.addEventListener("click",this.showAddForm),this.addFileElement.addEventListener("click",this.fileLoader.openForm),this.addAudioElement.addEventListener("click",this.mediaLoader.openMedia),this.addVideoElement.addEventListener("click",this.mediaLoader.openMedia),this.addGeoElement.addEventListener("click",this.geolocation.attachGeo)}buildMessageElement(e,t,i,a,o){if(-1!==[...this.messages.values()].indexOf(t))return[...this.messages.entries()].filter((({1:e})=>e===t)).map((([e])=>e))[0];let n="";switch(e){case"text":n=s.createMessageElement(i,a,o);break;case"image":n=s.createImageElement(this.server,i,a,o);break;case"video":n=s.createVideoElement(this.server,i,a,o);break;case"audio":n=s.createAudioElement(this.server,i,a,o);break;case"file":n=s.createFileElement(this.server,i,a,o)}return this.messages.set(n,t),n.addEventListener("mouseenter",this.showMessageDot),n.addEventListener("mouseleave",this.removeMessageDot),n}renderMessages(e,s,t){for(const t of e){const e=this.buildMessageElement(t.type,t.id,t.message,t.geo,t.date);-1!==s.indexOf(t.id)&&this.favourites.showFavouriteMark(t.id),t.pinned&&this.pin.markPinnedMessage(t.id),this.messagesElement.prepend(e),this.databasePosition||this.scrollBottom(e)}this.databasePosition=t,this.databasePosition>0&&(this.upperMessageElement=this.messagesElement.querySelector(".chaos_messages_message:nth-child(3)"))}lazyLoad(){this.databasePosition<=0||this.upperMessageElement&&this.upperMessageElement.getBoundingClientRect().bottom>0&&(this.upperMessageElement="",this.request.send("load",this.databasePosition))}showSelectMessage(e){const t=this.buildMessageElement(e.type,e.id,e.message,e.geo,e.date),i=s.createSelectContainer(e.date),a=i.querySelector(".chaos_select_close");i.append(t),this.parentElement.querySelector(".chaos_messages").replaceWith(i),a.addEventListener("click",this.closeSelectMessage)}closeSelectMessage(){this.parentElement.querySelector(".chaos_select_container")&&(this.parentElement.querySelector(".chaos_select_container").replaceWith(this.messagesElement),this.messagesElement.scrollTop=this.messagesElement.scrollHeight-this.messagesElement.getBoundingClientRect().height)}showAddForm(){this.addFormElement.classList.toggle("chaos_add_container_visible"),this.clipElement.classList.toggle("chaos_form_clip_active")}submitForm(e){e.preventDefault(),this.inputElement.value?this.request.send("message",{text:this.inputElement.value,geo:this.geolocation.coords}):this.showError()}addMessage(e,s,t,i){const a=this.buildMessageElement("text",e,s,t,i);a.classList.add("chaos_messages_message_animation"),a.addEventListener("animationend",(()=>{a.classList.remove("chaos_messages_message_animation")})),this.messagesElement.append(a),this.scrollBottom(a),this.inputElement.value="",this.geolocation.removeCoords()}addFile(e,s,t,i){const a=this.buildMessageElement(e,s,t,i);a.classList.add("chaos_messages_message_animation"),this.messagesElement.append(a),this.scrollBottom(a)}showMessageDot(e){const s=e.target.querySelector(".chaos_message_tools");s.classList.add("chaos_message_tools_show"),s.addEventListener("click",this.showMessageTools)}removeMessageDot(e){const s=e.target.querySelector(".chaos_message_tools");s.classList.remove("chaos_message_tools_show"),s.classList.remove("chaos_message_tools_active");const t=e.target.querySelector(".chaos_message_tools_container");t&&(s.removeEventListener("click",this.closeMessageTools),t.remove())}showMessageTools(e){const t=e.target;t.classList.add("chaos_message_tools_active"),t.removeEventListener("click",this.showMessageTools),t.addEventListener("click",this.closeMessageTools);const i=s.createToolsElements();t.after(i);const a=i.querySelector(".chaos_message_tools_delete"),o=i.querySelector(".chaos_message_tools_pin"),n=i.querySelector(".chaos_message_tools_favourite");a.addEventListener("click",this.deleteMessage),o.addEventListener("click",this.pin.pinMessage),n.addEventListener("click",this.favourites.addToFavourites)}closeMessageTools(e){const s=e.target,t=s.closest(".chaos_message_header").querySelector(".chaos_message_tools_container");t&&t.remove(),s.classList.toggle("chaos_message_tools_active"),s.removeEventListener("click",this.closeMessageTools),s.addEventListener("click",this.showMessageTools)}deleteMessage(e){const s=this.messages.get(e.target.closest(".chaos_messages_message"));this.request.send("delete",s)}deleteMessageElement(e){this.parentElement.querySelector(".chaos_select_container")&&(this.closeSelectMessage(),this.sidePanel.closeCategory()),this.pin.pinnedMessage===e&&this.pin.removePinnedMessage(),[...this.messages.entries()].filter((({1:s})=>s===e)).map((([e])=>e)).forEach((e=>{this.messages.delete(e),e.remove()}))}scrollBottom(e){let s=e.querySelectorAll(".chaos_message_body video, .chaos_message_body audio");[...s].forEach((e=>{e.addEventListener("loadeddata",(()=>{this.messagesElement.scrollTop=this.messagesElement.scrollHeight-this.messagesElement.getBoundingClientRect().height}))})),s=e.querySelectorAll(".chaos_message_body img"),[...s].forEach((e=>{e.addEventListener("load",(()=>{this.messagesElement.scrollTop=this.messagesElement.scrollHeight-this.messagesElement.getBoundingClientRect().height}))})),this.messagesElement.scrollTop=this.messagesElement.scrollHeight-this.messagesElement.getBoundingClientRect().height}showError(){this.inputElement.classList.add("chaos_form_invalid"),this.inputElement.addEventListener("keydown",this.removeError)}removeError(){this.inputElement.classList.remove("chaos_form_invalid"),this.inputElement.removeEventListener("keydown",this.removeError)}connectionPending(){this.connectionPendingElement=s.createPendingConnectionElement(),this.parentElement.querySelector(".chaos_container").append(this.connectionPendingElement)}connectionSuccess(){this.connectionPendingElement&&this.connectionPendingElement.remove()}connectionError(){const e=s.createErrorConnectionElement();this.parentElement.querySelector(".chaos_container").append(e)}}(document.querySelector(".chaos_organizer"),"http://localhost:7070").init()}();